import asyncio
import logging
import sqlite3
from pathlib import Path
from aiogram import Bot, Dispatcher, Router, F
from aiogram.types import Message, CallbackQuery, InputFile, FSInputFile, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import CommandStart
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.client.default import DefaultBotProperties
from aiogram.enums import ParseMode
import sys
import datetime

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
TOKEN = "8371778406:AAGyZlx_5bnmDIpuHzuHboHVa5mXBDWZbMQ"  # –í–∞—à —Ç–æ–∫–µ–Ω
ADMIN_ID = 7225974704  # ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä
router = Router()
bot = Bot(token=TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
dp = Dispatcher()

# –°–æ—Å—Ç–æ—è–Ω–∏—è FSM
class AdminStates(StatesGroup):
    waiting_for_queue_number = State()

class SupportStates(StatesGroup):
    waiting_for_support_message = State()

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è message_id —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
support_messages = {}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_database():
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    # –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        user_id INTEGER PRIMARY KEY,
        username TEXT,
        first_name TEXT,
        first_seen DATETIME,
        last_seen DATETIME
    )
    ''')
    
    conn.commit()
    conn.close()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–≤–æ–≥–æ –≤—Ö–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def check_first_time_user(user_id):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT * FROM users WHERE user_id = ?', (user_id,))
    user = cursor.fetchone()
    
    is_first_time = user is None
    
    conn.close()
    return is_first_time

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
def add_new_user(user_id, username, first_name):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    cursor.execute('''
    INSERT INTO users (user_id, username, first_name, first_seen, last_seen)
    VALUES (?, ?, ?, ?, ?)
    ''', (user_id, username, first_name, now, now))
    
    conn.commit()
    conn.close()
    return True

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
def update_last_seen(user_id):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    now = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    cursor.execute('''
    UPDATE users SET last_seen = ? WHERE user_id = ?
    ''', (now, user_id))
    
    conn.commit()
    conn.close()

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
async def send_first_start_to_admin(user_id: int, username: str, first_name: str):
    try:
        await bot.send_message(
            ADMIN_ID,
            f"üë§ <b>–ü–ï–†–í–´–ô –ó–ê–ü–£–°–ö –±–æ—Ç–∞ –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º</b>\n\n"
            f"üÜï <b>–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> @{username or '–Ω–µ—Ç'}\n"
            f"üÜî <b>ID:</b> {user_id}\n"
            f"üë§ <b>–ò–º—è:</b> {first_name}\n"
            f"üìÖ <b>–î–∞—Ç–∞:</b> {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
        )
    except Exception as e:
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ: {e}")

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
def get_main_menu():
    keyboard = [
        [InlineKeyboardButton(text="üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", callback_data="instruction")],
        [InlineKeyboardButton(text="üì≤ –°–∫–∞—á–∞—Ç—å Nicegram", web_app={"url": "https://nicegram.app/"})],
        [InlineKeyboardButton(text="üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ—Ñ–∞—É–Ω–¥", callback_data="check_refund")],
        [InlineKeyboardButton(text="üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞", callback_data="support")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ "–ù–∞–∑–∞–¥"
def get_back_keyboard():
    keyboard = [[InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è"
def get_instruction_keyboard():
    keyboard = [
        [InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]
    ]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –∞–¥–º–∏–Ω–∞
def get_admin_keyboard(user_id):
    keyboard = [[InlineKeyboardButton(text="üìã –ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –æ—á–µ—Ä–µ–¥—å", callback_data=f"queue_{user_id}")]]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
def get_support_keyboard():
    keyboard = [[InlineKeyboardButton(text="‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data="back_to_main")]]
    return InlineKeyboardMarkup(inline_keyboard=keyboard)

# –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
@router.message(CommandStart())
async def cmd_start(message: Message):
    user = message.from_user
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–π –ª–∏ —ç—Ç–æ –∑–∞–ø—É—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ë–î
    is_first_time = check_first_time_user(user.id)
    
    if is_first_time:
        # –≠—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ë–î
        await send_first_start_to_admin(user.id, user.username, user.first_name)
        add_new_user(user.id, user.username, user.first_name)
    else:
        # –ù–µ –ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞
        update_last_seen(user.id)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    photo_path = Path("1.png")
    if photo_path.exists():
        photo = FSInputFile("1.png")
        await message.answer_photo(
            photo=photo,
            caption="""–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
            reply_markup=get_main_menu()
        )
    else:
        await message.answer(
            """–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
            reply_markup=get_main_menu()
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
@router.callback_query(F.data == "instruction")
async def instruction_handler(callback: CallbackQuery):
    instruction_text = """<b>üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</b>

1. –°–∫–∞—á–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Nicegram —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞.
2. –û—Ç–∫—Ä–æ–π—Ç–µ Nicegram –∏ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç.
3. –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç ¬´Nicegram¬ª.
4. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞.
5. –í –º–µ–Ω—é –±–æ—Ç–∞ –Ω–∞–∂–º–∏—Ç–µ 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ—Ñ–∞—É–Ω–¥'.
6. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –±–æ—Ç—É."""
    
    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π (–ø–æ–¥–º–µ–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
    await callback.message.edit_caption(
        caption=instruction_text,
        reply_markup=get_instruction_keyboard()
    )
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Ä–µ—Ñ–∞—É–Ω–¥
@router.callback_query(F.data == "check_refund")
async def check_refund_handler(callback: CallbackQuery):
    user = callback.from_user
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–æ—Å—å–±–æ–π –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª
    await callback.message.answer(
        "üóÇ –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Ñ–æ—Ä–º–∞—Ç–∞ .txt –∏–ª–∏ .zip –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:",
        reply_markup=get_back_keyboard()
    )
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
@router.callback_query(F.data == "support")
async def support_handler(callback: CallbackQuery, state: FSMContext):
    user = callback.from_user
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
    support_msg = await callback.message.answer(
        "üÜò <b>–û–±—Ä–∞—â–µ–Ω–∏–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</b>\n\n–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
        reply_markup=get_back_keyboard()
    )
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
    support_messages[user.id] = support_msg.message_id
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
    await state.set_state(SupportStates.waiting_for_support_message)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏
@router.message(SupportStates.waiting_for_support_message)
async def process_support_message(message: Message, state: FSMContext):
    user = message.from_user
    
    # –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ
    if user.id in support_messages:
        try:
            await bot.delete_message(chat_id=user.id, message_id=support_messages[user.id])
            del support_messages[user.id]
        except:
            pass
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏
    await message.answer(
        "‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ! –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç.\n\n–û–±—ã—á–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: 30 –º–∏–Ω—É—Ç",
        reply_markup=get_support_keyboard()
    )
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é - –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
@router.callback_query(F.data == "back_to_main")
async def back_to_main_handler(callback: CallbackQuery):
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É —Å–æ–æ–±—â–µ–Ω–∏—è caption (—Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é)
        photo_path = Path("1.png")
        
        if hasattr(callback.message, 'caption') and callback.message.caption is not None:
            # –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ –∏ –ø–æ–¥–ø–∏—Å—å—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è)
            if photo_path.exists():
                # –ü–æ–¥–º–µ–Ω—è–µ–º —Ñ–æ—Ç–æ –∏ —Ç–µ–∫—Å—Ç –Ω–∞ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
                await callback.message.edit_media(
                    media=InputFile("1.png"),
                    caption="""–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
                    reply_markup=get_main_menu()
                )
            else:
                # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
                await callback.message.edit_caption(
                    caption="""–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
                    reply_markup=get_main_menu()
                )
        else:
            # –≠—Ç–æ –æ–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if photo_path.exists():
                # –£–¥–∞–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å —Ñ–æ—Ç–æ
                await callback.message.delete()
                photo = FSInputFile("1.png")
                await callback.message.answer_photo(
                    photo=photo,
                    caption="""–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
                    reply_markup=get_main_menu()
                )
            else:
                # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
                await callback.message.edit_text(
                    """–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
                    reply_markup=get_main_menu()
                )
    
    except Exception as e:
        # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–º–µ–Ω–∏—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            photo_path = Path("1.png")
            if photo_path.exists():
                photo = FSInputFile("1.png")
                await callback.message.answer_photo(
                    photo=photo,
                    caption="""–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
                    reply_markup=get_main_menu()
                )
            else:
                await callback.message.answer(
                    """–ü—Ä–∏–≤–µ—Ç! –Ø - –ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –ø–æ–ø–∞—Å—Ç—å—Å—è –Ω–∞ –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤. –Ø –ø–æ–º–æ–≥—É –æ—Ç–ª–∏—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–¥–∞—Ä–æ–∫ –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤–∏–∑—É–∞–ª–∞, —á–∏—Å—Ç—ã–π –ø–æ–¥–∞—Ä–æ–∫ –±–µ–∑ —Ä–µ—Ñ–∞—É–Ω–¥–∞ –∏ –ø–æ–¥–∞—Ä–æ–∫, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –≤–µ—Ä–Ω—É–ª–∏ –¥–µ–Ω—å–≥–∏.

–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ:""",
                    reply_markup=get_main_menu()
                )
        except Exception as e2:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e2}")
    
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
@router.message(F.document)
async def handle_document(message: Message):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    file_name = message.document.file_name or ""
    if not file_name.lower().endswith(('.txt', '.zip')):
        await message.answer(
            "ü§î –≠—Ç–æ –Ω–µ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Ñ–∞–π–ª –ø—Ä–æ–≤–µ—Ä–∫–∏‚Ä¶",
            reply_markup=InlineKeyboardMarkup(
                inline_keyboard=[[InlineKeyboardButton(text="üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è", callback_data="instruction")]]
            )
        )
        return
    
    user = message.from_user
    
    # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await message.answer("‚úÖ –§–∞–π–ª –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É. –û–∂–∏–¥–∞–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.")
    
    # –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º —Ñ–∞–π–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    user_info = f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @{user.username or '–Ω–µ—Ç'} (ID: {user.id})"
    await bot.send_document(
        ADMIN_ID,
        document=message.document.file_id,
        caption=f"üì• <b>–ë–æ—Ç –ø–æ–ª—É—á–∏–ª —Ñ–∞–π–ª</b>\n{user_info}\nüìÑ <b>–ò–º—è —Ñ–∞–π–ª–∞:</b> {file_name}",
        reply_markup=get_admin_keyboard(user.id)
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–æ—Å—Ç–∞–≤–∏—Ç—å –Ω–∞ –æ—á–µ—Ä–µ–¥—å" —É –∞–¥–º–∏–Ω–∞
@router.callback_query(F.data.startswith("queue_"))
async def queue_handler(callback: CallbackQuery, state: FSMContext):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
    if callback.from_user.id != ADMIN_ID:
        await callback.answer("–í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!", show_alert=True)
        return
    
    try:
        user_id = int(callback.data.split("_")[1])
    except ValueError:
        await callback.answer("‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö", show_alert=True)
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º user_id –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏
    await state.set_state(AdminStates.waiting_for_queue_number)
    await state.update_data(user_id=user_id)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–æ–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏
    await callback.message.answer(
        f"üìù <b>–ü–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ –æ—á–µ—Ä–µ–¥—å</b>\n\n–ù–∞–ø–∏—à–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}:"
    )
    
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–æ–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏ –æ—Ç –∞–¥–º–∏–Ω–∞
@router.message(AdminStates.waiting_for_queue_number)
async def process_queue_number(message: Message, state: FSMContext):
    if message.from_user.id != ADMIN_ID:
        await message.answer("–í—ã –Ω–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!")
        return
    
    try:
        queue_num = int(message.text)
    except ValueError:
        await message.answer("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º user_id –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    user_id = data.get('user_id')
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        await bot.send_message(
            user_id,
            f"‚úÖ –í—ã –ø–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ –æ—á–µ—Ä–µ–¥—å ‚Ññ{queue_num}"
        )
    except Exception as e:
        await message.answer(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id}")
        await state.clear()
        return
    
    # –°–æ–æ–±—â–∞–µ–º –∞–¥–º–∏–Ω—É
    await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –ø–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å ‚Ññ{queue_num}")
    
    # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∫—Ä–æ–º–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤)
@router.message()
async def handle_other_messages(message: Message):
    # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∞
    if message.from_user.id == ADMIN_ID:
        return

async def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    init_database()
    
    dp.include_router(router)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
    try:
        await bot.send_message(ADMIN_ID, "ü§ñ <b>–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!</b>")
    except Exception as e:
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –æ –∑–∞–ø—É—Å–∫–µ: {e}")
    
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    print("üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
